## Codebase Patterns
- Project lives at eval/approach1/ - all source in eval/approach1/src/
- ESM project with "type": "module" in package.json
- TypeScript strict mode with JSX preserve and bundler module resolution
- Use `npx tsc --noEmit` from eval/approach1/ for typecheck
- Use `npx vitest run` from eval/approach1/ for tests
- Shared types in src/types.ts - import from there
- Logger utility in src/utils/logger.ts with chalk-based methods
- Tests go in __tests__/ directories alongside source (e.g., src/input/__tests__/diff-parser.test.ts)
- Import with .js extension for ESM (e.g., import from '../types.js')
- Don't use `promisify(execFile)` with vitest mocks - write a manual Promise wrapper instead
- When execFile has an options arg (e.g., cwd), mock must handle both 3-arg and 4-arg overloads

# Ralph Progress Log
Started: Fri Feb 27 04:37:21 PM EST 2026
---

## 2026-02-27 - US-001
- What was implemented: Project scaffolding with package.json, tsconfig.json, types.ts, cli.ts, and logger.ts
- Files changed:
  - eval/approach1/package.json (dependencies: ts-morph, commander, chalk; devDeps: typescript, tsx, vitest, @types/node)
  - eval/approach1/tsconfig.json (strict, ESM, JSX preserve, bundler resolution)
  - eval/approach1/src/types.ts (all shared interfaces: FileDiff, ASTRepresentation, PatternDefinition, DetectionResult, DetectionStatus enum, EvalReport, MatchResult, NoiseInstance)
  - eval/approach1/src/cli.ts (commander-based CLI with --golden-pr, --migration-pr, --golden-dir, --migration-dir, --output-dir, --verbose)
  - eval/approach1/src/utils/logger.ts (chalk-based logging: info, warn, error, verbose, success)
- **Learnings for future iterations:**
  - npm install succeeds and npx tsc --noEmit passes clean
  - CLI uses commander with both PR URL and local directory modes
  - DetectionStatus enum has 6 values: CORRECT, MISSING, INCORRECT, UNNECESSARY, FILE_MISSING, NOT_APPLICABLE
---

## 2026-02-27 - US-002
- What was implemented: Unified diff parser that converts raw diff text into structured FileDiff objects
- Files changed:
  - eval/approach1/src/input/diff-parser.ts (parseDiff function: splits diff into file chunks, parses hunks, extracts added/removed lines with line numbers)
  - eval/approach1/src/input/__tests__/diff-parser.test.ts (10 tests: empty input, single-file, multi-file, renames, binary, no-newline-at-eof, hunk headers, multiple hunks, new file, deleted file)
- **Learnings for future iterations:**
  - Unified diff format: "diff --git a/path b/path" separates files, "@@ -old,count +new,count @@" separates hunks
  - The "\ No newline at end of file" marker should be preserved in hunk lines but not counted as added/removed
  - Renamed files use "rename from/to" lines and also have different --- and +++ paths
  - Binary files have "Binary files ... differ" or "GIT binary patch" markers
  - stripABPrefix utility removes a/ or b/ prefix from diff paths
---

## 2026-02-27 - US-003
- What was implemented: PR fetcher that calls `gh pr diff <url>` and returns parsed FileDiff[]
- Files changed:
  - eval/approach1/src/input/pr-fetcher.ts (fetchPRDiff, validateGhCli functions with manual execFile async wrapper)
  - eval/approach1/src/input/__tests__/pr-fetcher.test.ts (9 tests: gh auth validation, invalid URLs, mocked diff parsing, empty diff, error handling)
- **Learnings for future iterations:**
  - Don't use `promisify(execFile)` when mocking with vitest - the real execFile has util.promisify.custom that returns {stdout, stderr}, but vi.fn() doesn't. Write a manual Promise wrapper instead.
  - Mock `node:child_process` at module level with `vi.mock('node:child_process', ...)` and use sequential mock implementations for multi-call flows (auth check then actual command)
  - PR URL validation regex: `^https://github.com/[\w.-]+/[\w.-]+/pull/\d+/?$`
---

## 2026-02-27 - US-004
- What was implemented: Local directory reader that generates diffs from git repos and reads file contents for AST analysis
- Files changed:
  - eval/approach1/src/input/local-reader.ts (validateGitRepo, readLocalDiff, readFileContents functions with auto-detection of default branch and merge-base diffing)
  - eval/approach1/src/input/__tests__/local-reader.test.ts (13 tests: git repo validation, diff reading, default branch fallback, multi-file diffs, file content reading, error handling)
- **Learnings for future iterations:**
  - When mocking execFile with an options argument (cwd), the callback is the 4th argument, not the 3rd. Must handle both overload signatures in mock: `typeof _opts === 'function' ? _opts : callback`
  - Default branch detection: first try `git symbolic-ref refs/remotes/origin/HEAD`, then fall back to checking `main` and `master` with `git rev-parse --verify`
  - Use `git merge-base <default-branch> HEAD` to find the common ancestor, then `git diff <merge-base> HEAD` for the branch diff
  - readFileContents uses Promise.all for parallel file reads and silently skips unreadable files (deleted, binary, etc.)
---
